---
import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import BaseLayout from '@src/layouts/BaseLayout.astro';
import { slugify, unslugify } from '@src/utils';
import PostsByYear from '@src/components/PostsByYear.astro';

type BlogPost = CollectionEntry<'blog'>;
export const getStaticPaths = async () => {
	const allPosts: BlogPost[] = await getCollection('blog');
	const postsByTag = new Map<string, BlogPost[]>();

	for (const post of allPosts) {
		for (const rawTag of post.data.tags || []) {
			const tag = slugify(rawTag);
			if (!tag) continue;

			const taggedPosts = postsByTag.get(tag);
			if (taggedPosts) {
				taggedPosts.push(post);
			} else {
				postsByTag.set(tag, [post]);
			}
		}
	}

	return [...postsByTag.entries()].map(([tag, taggedPosts]) => ({
		params: { tag },
		props: {
			taggedPosts: taggedPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
		}
	}));
};

const { tag } = Astro.params;
const { taggedPosts = [] } = Astro.props as { taggedPosts?: BlogPost[] };
const title = `All Posts Tagged with ${unslugify(tag || '')}`;
const description = `All Posts Tagged with ${unslugify(tag || '')}`;
---

<BaseLayout
	title={title}
	description={description}
>
  <div class='container'>
    <div class="mb-10">
      <h1 class="text-3xl font-bold mb-2">{title}</h1>
    </div>
    <PostsByYear posts={taggedPosts}/>
  </div>
</BaseLayout>
